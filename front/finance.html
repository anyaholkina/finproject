<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои финансы - Smart Money</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/finance.css" rel="stylesheet">
    <link href="css/theme.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
    @media (max-width: 767.98px) {
      .main, main.container {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }
      .row.g-4 {
        margin-left: 0 !important;
        margin-right: 0 !important;
        row-gap: 6px !important;
      }
      .col-12 {
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
      .mb-3, .mb-4 {
        margin-bottom: 8px !important;
      }
      .col-12.col-md-4.mb-3:first-child {
        margin-bottom: 0 !important;
        order: 2;
      }
      .col-12.col-md-4.mb-3:nth-child(2) {
        margin-top: 0 !important;
        order: 1;
      }
      .col-12.col-md-4.mb-3:nth-child(3) {
        order: 3;
        margin-top: 0 !important;
      }
      .col-12.col-md-4.mb-3 .bg-white[style] {
        height: auto !important;
        min-height: 0 !important;
      }
      .col-12.col-md-4.mb-3:first-child .bg-white:last-child {
        margin-bottom: 0 !important;
      }
      .col-12.col-md-4.mb-3:nth-child(3) .bg-white:first-child {
        margin-top: 0 !important;
      }
      .p-4 {
        padding: 12px !important;
      }
      .shadow-sm {
        box-shadow: 0 1px 4px rgba(0,0,0,0.06) !important;
      }
      .rounded-4 {
        border-radius: 10px !important;
      }
      .footer {
        padding-top: 10px !important;
        padding-bottom: 10px !important;
        margin-top: 10px !important;
      }
      .hero-section .container-fluid,
      .hero-section .container {
        max-width: 100vw !important;
        width: 100vw !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin: 0 !important;
      }
      .hero-section h1 {
        font-size: 1.05rem !important;
        line-height: 1.15 !important;
        word-break: break-word !important;
        white-space: normal !important;
        font-weight: 600 !important;
        margin-bottom: 1rem !important;
        padding-left: 4vw !important;
        padding-right: 4vw !important;
        letter-spacing: 0 !important;
      }
      .hero-section h4 {
        font-size: 0.95rem !important;
        line-height: 1.2 !important;
        word-break: break-word !important;
        white-space: normal !important;
        padding-left: 4vw !important;
        padding-right: 4vw !important;
      }
      .btn-4 {
        font-size: 1rem !important;
        width: 95vw !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        height: 44px !important;
        border-radius: 24px !important;
        padding: 0 8px !important;
      }
      .hero-section {
        padding-top: 100px !important;
      }
    }
    .chart-type-btn {
      background: #f3f3f3 !important;
      color: #222 !important;
      border: none !important;
      border-radius: 18px !important;
      margin: 0 2px !important;
      font-weight: 500 !important;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      padding: 8px 20px !important;
    }
    .chart-type-btn.active, .chart-type-btn:active {
      background: linear-gradient(90deg, #A6E6B5 0%, #6C7BFF 100%) !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(166,230,181,0.15);
    }
    .chart-type-btn:hover {
      background: #e0e0e0 !important;
      color: #111 !important;
    }
    .cat-name {
      display: inline-block;
      max-width: 200px;
      opacity: 1;
      overflow: hidden;
      white-space: nowrap;
      transition: max-width 0.3s, opacity 0.3s;
    }
    .cat-name:not(.expanded) {
      max-width: 0;
      opacity: 0;
    }
    .edit-operation-btn {
      position: relative;
      pointer-events: auto;
    }
    .edit-operation-btn i {
      pointer-events: none;
    }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Шапка -->
    <header class="bg-white shadow-sm py-2 mb-4">
        <div class="container d-flex align-items-center justify-content-between">
            <a href="index.html" class="d-flex align-items-center text-decoration-none d-none d-md-flex">
                <img src="images/logo — копия.png" alt="Логотип" style="height:48px;" class="me-2">
            </a>
            <div class="position-absolute start-50 translate-middle-x d-none d-md-block">
                <h1 class="fw-bold mb-0 fs-2 text-center" id="mainTitle" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#financeModal">
                    Мои финансы <i class="bi bi-chevron-down ms-2"></i>
                </h1>
            </div>
            <!-- Мобильная шапка -->
            <div class="d-flex w-100 justify-content-between align-items-center d-md-none">
                <button class="btn btn-link p-0 header-icon" data-bs-toggle="modal" data-bs-target="#notificationsModal"><i class="bi bi-bell fs-3"></i></button>
                <h1 class="fw-bold mb-0 fs-5 text-center flex-grow-1" id="mainTitleMobile" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#financeModal">
                    Мои финансы <i class="bi bi-chevron-down ms-2"></i>
                </h1>
                <button class="btn btn-link p-0 header-icon" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-list fs-2"></i></button>
            </div>
            <!-- Десктопные иконки -->
            <div class="d-flex align-items-center gap-2 d-none d-md-flex">
                <button class="btn btn-link p-0 header-icon" data-bs-toggle="modal" data-bs-target="#notificationsModal"><i class="bi bi-bell fs-3"></i></button>
                <button class="btn btn-link p-0 header-icon" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-list fs-2"></i></button>
            </div>
        </div>
    </header>

    <!-- Основное содержимое -->
    <main class="container flex-grow-1">
        <div class="row g-4 align-items-start">
            <div class="col-12 col-md-4 mb-3">
                <div class="bg-white rounded-4 shadow-sm p-4" style="height: 410px; min-height: 410px;">
                    <div class="d-flex flex-column align-items-center justify-content-center position-relative">
                        <h2 class="fs-4 fw-bold mb-0 text-center w-100">Категории</h2>
                        <button class="btn btn-light btn-sm rounded-circle position-absolute end-0 top-0" id="addCategoryBtn"><i class="bi bi-plus"></i></button>
                    </div>
                    <ul class="list-unstyled" id="categoriesList"></ul>
                </div>
                <div class="bg-white rounded-4 shadow-sm p-4 mb-3 d-none" id="familyMembersBlock">
                    <div class="d-flex flex-column align-items-center justify-content-center mb-3 position-relative">
                        <h2 class="fs-4 fw-bold mb-0 text-center w-100">Участники</h2>
                        <button class="btn btn-light btn-sm rounded-circle position-absolute end-0 top-0" id="addMemberBtn"><i class="bi bi-plus"></i></button>
                    </div>
                    <ul class="list-unstyled mb-4" id="familyMembersList"></ul>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3">
                <div class="bg-white rounded-4 shadow-sm p-4" style="min-height: 410px;">
                    <div class="d-flex flex-column align-items-center justify-content-center mb-3" style="height: 120px;">
                        <h1 class="fw-bold fs-3 mb-2" id="mainTitleCenter" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#financeModal">
                            <span class="d-block d-md-inline">Финансовый учёт</span>
                            <span class="d-block d-md-inline">и управление</span>
                        </h1>
                        <h2 class="fs-4 fw-bold mb-0">Бюджет</h2>
                    </div>
                    <div class="d-flex flex-column align-items-center justify-content-center mb-3" style="height: 260px;">
                        <canvas id="budgetChart" style="max-width:260px;"></canvas>
                    </div>
                    <div class="d-flex justify-content-center mb-2" style="height: 40px;">
                        <div class="btn-group rounded-pill shadow-sm overflow-hidden" role="group">
                            <button type="button" class="btn btn-light chart-type-btn active" data-type="pie">Круговая</button>
                            <button type="button" class="btn btn-light chart-type-btn" data-type="bar">Столбчатая</button>
                        </div>
                    </div>
                    <button id="downloadChartBtn" class="btn btn-success w-100 rounded-pill mb-3">Скачать</button>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3">
                <div class="bg-white rounded-4 shadow-sm p-4" style="min-height: 410px;">
                    <div class="d-flex flex-column align-items-center justify-content-center mb-3 position-relative">
                        <h2 class="fs-4 fw-bold mb-0 text-center w-100">История</h2>
                        <button class="btn btn-light btn-sm rounded-circle position-absolute end-0 top-0" id="addOperationBtn"><i class="bi bi-plus"></i></button>
                    </div>
                    <!-- Tabs -->
                    <ul class="nav nav-tabs justify-content-center mb-2" id="historyTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-type="expense" id="tab-expense" type="button">РАСХОДЫ</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-type="income" id="tab-income" type="button">ДОХОДЫ</button>
                        </li>
                    </ul>
                    <!-- Period filters -->
                    <ul class="nav nav-pills justify-content-center mb-2 flex-wrap gap-1" id="historyPeriods">
                        <li class="nav-item"><button class="nav-link px-2 py-1 small" data-period="day">День</button></li>
                        <li class="nav-item"><button class="nav-link px-2 py-1 small active" data-period="week">Неделя</button></li>
                        <li class="nav-item"><button class="nav-link px-2 py-1 small" data-period="month">Месяц</button></li>
                        <li class="nav-item"><button class="nav-link px-2 py-1 small" data-period="year">Год</button></li>
                        <li class="nav-item"><button class="nav-link px-2 py-1 small" data-period="custom">Период</button></li>
                    </ul>
                    <!-- Period and sort -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <button class="btn btn-link p-0" id="periodPrev"><i class="bi bi-chevron-left"></i></button>
                            <span id="periodLabel">22 июл - 28 июл</span>
                            <button class="btn btn-link p-0" id="periodNext"><i class="bi bi-chevron-right"></i></button>
                        </div>
                        <div class="text-muted" style="cursor:pointer;" id="sortToggle">По дате <i class="bi bi-chevron-down"></i></div>
                    </div>
                    <div class="mb-2 fw-bold">Всего: <span id="historyTotal">7 030 ₽</span></div>
                    <!-- List of operations -->
                    <div class="history-list" id="historyList" style="max-height:260px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Футер -->
    <footer class="footer pt-3 pb-1" style="background-color: #3f3e3e; border-top: 1px solid #555;">
        <div class="container">
            <div class="row align-items-center text-center text-md-start">
                <div class="col-md-4 mb-3 mb-md-0 d-flex flex-column align-items-center align-items-md-start">
                    <img src="images/logo — копия.png" class="img-thumbnail mb-2" style="max-height:38px; background:transparent; border:none;" alt="Логотип">
                    <div class="fw-bold text-white" style="font-size:17px;">Практиканты 2025</div>
                </div>
                <div class="col-md-2 mb-2 mb-md-0">
                    <div class="d-flex align-items-center mb-2 gap-2 justify-content-center justify-content-md-start">
                        <i class="bi bi-info-circle text-white"></i>
                        <span class="fw-semibold text-white" style="font-size:16px;">О сервисе</span>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="#" class="footer-link">Ссылка</a></li>
                        <li><a href="#" class="footer-link">Ссылка</a></li>
                    </ul>
                </div>
                <div class="col-md-2 mb-2 mb-md-0">
                    <div class="d-flex align-items-center mb-2 gap-2 justify-content-center justify-content-md-start">
                        <i class="bi bi-question-circle text-white"></i>
                        <span class="fw-semibold text-white" style="font-size:16px;">Помощь</span>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="#" class="footer-link">FAQ</a></li>
                        <li><a href="#" class="footer-link">Поддержка</a></li>
                    </ul>
                </div>
                <div class="col-md-2 mb-2 mb-md-0">
                    <div class="d-flex align-items-center mb-2 gap-2 justify-content-center justify-content-md-start">
                        <i class="bi bi-envelope text-white"></i>
                        <span class="fw-semibold text-white" style="font-size:16px;">Контакты</span>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="#" class="footer-link">Email</a></li>
                        <li><a href="#" class="footer-link">Телефон</a></li>
                    </ul>
                </div>
            </div>
            <div class="text-center mt-3" style="color:#bbb; font-size:13px;">&copy; 2025 Smart Money. Все права защищены.</div>
        </div>
    </footer>

    <!-- Модальное окно выбора группы -->
    <div class="modal fade" id="financeModal" tabindex="-1" aria-labelledby="financeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="financeModalLabel">Выберите группу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-primary w-100 mb-2" onclick="selectOption('Мои финансы')">Мои финансы</button>
                    <button class="btn btn-primary w-100" onclick="selectOption('Семья')">Семья</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно профиля -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <p class="text-muted mb-1">mail@mail.com</p>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="d-grid gap-2 p-3">
                    <button type="button" class="btn btn-outline-primary rounded-pill py-2">Профиль</button>
                    <button type="button" class="btn btn-outline-primary rounded-pill py-2">Семья</button>
                    <button type="button" class="btn btn-outline-primary rounded-pill py-2" id="settingsBtn">Настройки</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка: Добавить операцию -->
    <div class="modal fade" id="addOperationModal" tabindex="-1" aria-labelledby="addOperationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 p-3">
          <div class="modal-header border-0 pb-0">
            <h2 class="modal-title w-100 text-center fw-bold fs-2" id="addOperationModalLabel">Операции</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-0">
            <ul class="nav nav-tabs justify-content-center mb-3 border-0">
              <li class="nav-item"><a class="nav-link active" href="#">Расходы</a></li>
              <li class="nav-item"><span class="nav-link disabled" style="color:#bbb;">Доходы</span></li>
            </ul>
            <form>
              <div class="mb-3">
                <select class="form-select form-control-lg" style="border-radius:14px;" aria-label="Категория">
                  <option selected>Категория</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Сумма</label>
                <div class="input-group">
                  <input type="number" class="form-control form-control-lg" placeholder="Сумма" style="font-size:1.5rem; color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
                  <span class="input-group-text bg-white border-0" style="font-size:1.5rem;">₽</span>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Дата</label>
                <input type="date" class="form-control form-control-lg" placeholder="Дата" style="color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
              </div>
              <div class="mb-4">
                <label class="form-label">Комментарий</label>
                <input type="text" class="form-control form-control-lg" placeholder="Комментарий" style="color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
              </div>
              <button type="submit" class="btn w-100 py-2" style="background:#A6E6B5; border-radius:16px; font-size:1.5rem;">Добавить</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Модалка: Добавить категорию -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 p-3">
          <div class="modal-header border-0 pb-0">
            <h2 class="modal-title w-100 text-center fw-bold fs-2" id="addCategoryModalLabel">Добавить</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-0">
            <form>
              <div class="mb-3">
                <input type="text" class="form-control form-control-lg" placeholder="Категория" style="border-radius:14px;">
              </div>
              <div class="mb-3 d-flex align-items-center gap-3 justify-content-center">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="catType" id="catExpense" checked>
                  <label class="form-check-label" for="catExpense">Расходы</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="catType" id="catIncome">
                  <label class="form-check-label" for="catIncome">Доходы</label>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Иконка</label>
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:56px;height:56px;background:#CDECCB;font-size:2rem;">+</div>
                    <div class="small">Еще</div>
                  </div>
                </div>
              </div>
              <div class="mb-4">
                <label class="form-label">Лимит</label>
                <input type="number" class="form-control form-control-lg" placeholder="Лимит" style="color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
              </div>
              <button type="submit" class="btn w-100 py-2" style="background:#A6E6B5; border-radius:16px; font-size:1.5rem;">Добавить</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Модалка: Редактировать категорию -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 p-3">
          <div class="modal-header border-0 pb-0">
            <h2 class="modal-title w-100 text-center fw-bold fs-2" id="editCategoryModalLabel">Редактировать</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-0">
            <form>
              <div class="mb-3">
                <input type="text" class="form-control form-control-lg" placeholder="Категория" style="border-radius:14px;">
              </div>
              <div class="mb-3 d-flex align-items-center gap-3 justify-content-center">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="editCatType" id="editCatExpense" checked>
                  <label class="form-check-label" for="editCatExpense">Расходы</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="editCatType" id="editCatIncome">
                  <label class="form-check-label" for="editCatIncome">Доходы</label>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Иконка</label>
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle" style="width:56px;height:56px;background:#CDECCB;display:flex;align-items:center;justify-content:center;font-size:2rem;"> </div>
                    <div class="small">Название</div>
                  </div>
                  <div class="d-flex flex-column align-items-center">
                    <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:56px;height:56px;background:#CDECCB;font-size:2rem;">+</div>
                    <div class="small">Еще</div>
                  </div>
                </div>
              </div>
              <div class="mb-4">
                <label class="form-label">Лимит</label>
                <input type="number" class="form-control form-control-lg" placeholder="Лимит" style="color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
              </div>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-danger px-4" style="border-radius:14px;">Удалить</button>
                <button type="submit" class="btn" style="background:#A6E6B5; border-radius:16px; font-size:1.2rem; min-width:120px;">Сохранить</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно уведомлений -->
    <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-3">
                <div class="modal-header border-0 pb-0">
                    <h2 class="modal-title w-100 text-center fw-bold fs-2" id="notificationsModalLabel">Уведомления</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex align-items-center justify-content-center" style="min-height:120px;">
                    <div class="w-100 text-center text-muted fs-4">здесь пока пусто</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка: Редактировать операцию -->
    <div class="modal fade" id="editOperationModal" tabindex="-1" aria-labelledby="editOperationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 p-3">
          <div class="modal-header border-0 pb-0">
            <h2 class="modal-title w-100 text-center fw-bold fs-2" id="editOperationModalLabel">Редактировать операцию</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-0">
            <form>
              <div class="mb-3">
                <select class="form-select form-control-lg" style="border-radius:14px;" aria-label="Категория">
                  <option selected>Категория</option>
                </select>
              </div>
              <div class="mb-3 d-flex align-items-center gap-3 justify-content-center">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="editOpType" id="editOpExpense" checked>
                  <label class="form-check-label" for="editOpExpense">Расходы</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="editOpType" id="editOpIncome">
                  <label class="form-check-label" for="editOpIncome">Доходы</label>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Сумма</label>
                <div class="input-group">
                  <input type="number" class="form-control form-control-lg" placeholder="Сумма" style="font-size:1.5rem; color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
                  <span class="input-group-text bg-white border-0" style="font-size:1.5rem;">₽</span>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Дата</label>
                <input type="date" class="form-control form-control-lg" placeholder="Дата" style="color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
              </div>
              <div class="mb-4">
                <label class="form-label">Комментарий</label>
                <input type="text" class="form-control form-control-lg" placeholder="Комментарий" style="color:#bbb; border:none; border-bottom:1px solid #aaa; border-radius:0;">
              </div>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-danger px-4" style="border-radius:14px;">Удалить</button>
                <button type="submit" class="btn" style="background:#A6E6B5; border-radius:16px; font-size:1.2rem; min-width:120px;">Сохранить</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Модалка: Настройки -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 p-4" style="min-width:320px;">
          <div class="modal-header border-0 pb-0 align-items-center justify-content-between">
            <span class="fs-4 fw-normal" id="settingsEmail">Mail@mail.com</span>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-3 pb-0">
            <div class="d-grid gap-3 mb-4">
              <button class="d-flex align-items-center gap-2 px-4 py-3 rounded-4 border-0 w-100 theme-toggle-btn" style="background:#333;color:#fff;box-shadow:0 2px 8px #0001;font-size:1.3rem;">
                <i class="bi bi-moon-stars-fill fs-3"></i> <span class="theme-text">Темная тема</span>
              </button>
              <button class="d-flex align-items-center gap-2 px-4 py-3 rounded-4 border-0 w-100 contact-btn" style="background:#e5e5e5;color:#222;box-shadow:0 2px 8px #0001;font-size:1.3rem;">
                <i class="bi bi-chat-dots fs-3"></i> Связь
              </button>
            </div>
            <div class="text-center mt-4">
              <button class="btn border-0" style="color:#d00;font-size:1.2rem;">Выйти</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Модалка: Связь -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 p-4" style="min-width:320px;">
          <div class="modal-header border-0 pb-0 align-items-center justify-content-between">
            <h2 class="modal-title w-100 text-center fw-bold fs-2" id="contactModalLabel">Связь</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-3 pb-0">
            <div class="mb-3 text-center">
              <div class="mb-2">
                <i class="bi bi-envelope fs-3 me-2"></i>
                <span style="font-size:1.2rem;">vladfro2000@mail.ru</span>
              </div>
              <div>
                <i class="bi bi-telephone fs-3 me-2"></i>
                <span style="font-size:1.2rem;">+7 932 413-15-59</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Модалка: Профиль -->
    <div class="modal fade" id="profileInfoModal" tabindex="-1" aria-labelledby="profileInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-4" style="min-width:320px;">
                <div class="modal-header border-0 pb-0 align-items-center justify-content-between">
                    <h2 class="modal-title w-100 text-center fw-bold fs-2" id="profileInfoModalLabel">Профиль</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-3 pb-0">
                    <!-- Аватар и основная информация -->
                    <div class="text-center mb-4">
                        <div class="rounded-circle bg-light mx-auto mb-3" style="width:100px;height:100px;display:flex;align-items:center;justify-content:center;font-size:3rem;">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <h3 class="fs-4 fw-bold mb-1" id="profileNameTitle">Пожалуйста, введите свое имя</h3>
                        <div class="text-muted mb-3" id="profileEmailTitle">mail@mail.com</div>
                    </div>

                    <!-- Форма редактирования -->
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label">Имя</label>
                            <input type="text" class="form-control form-control-lg" id="profileNameInput" placeholder="Пожалуйста, введите свое имя" style="border-radius:14px;">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control form-control-lg" id="profileEmailInput" placeholder="Email" style="border-radius:14px;" readonly>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn" style="background:#A6E6B5; border-radius:16px; font-size:1.2rem;">Сохранить изменения</button>
                            <button type="button" class="btn btn-outline-danger rounded-pill px-4 py-2">Выйти</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка: Изменение пароля -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-4">
                <div class="modal-header border-0 pb-0">
                    <h2 class="modal-title w-100 text-center fw-bold fs-2" id="changePasswordModalLabel">Изменить пароль</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-3">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Текущий пароль</label>
                            <input type="password" class="form-control form-control-lg" style="border-radius:14px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Новый пароль</label>
                            <input type="password" class="form-control form-control-lg" style="border-radius:14px;">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Подтвердите новый пароль</label>
                            <input type="password" class="form-control form-control-lg" style="border-radius:14px;">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn" style="background:#A6E6B5; border-radius:16px; font-size:1.2rem;">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка: Семья -->
    <div class="modal fade" id="familyModal" tabindex="-1" aria-labelledby="familyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 p-4" style="min-width:320px;">
          <div class="modal-header border-0 pb-0 align-items-center justify-content-between">
            <h2 class="modal-title w-100 text-center fw-bold fs-2" id="familyModalLabel">Семья</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-3 pb-0">
            <ul class="list-unstyled mb-4">
              <li class="d-flex align-items-center mb-3">
                <span class="badge me-2" style="background:#6C7BFF;width:14px;height:14px;">&nbsp;</span>
                Анна
                <button class="btn btn-link btn-sm ms-auto edit-member-btn"><i class="bi bi-pencil"></i></button>
              </li>
              <li class="d-flex align-items-center mb-3">
                <span class="badge me-2" style="background:#FF7EB3;width:14px;height:14px;">&nbsp;</span>
                Иван
                <button class="btn btn-link btn-sm ms-auto edit-member-btn"><i class="bi bi-pencil"></i></button>
              </li>
              <li class="d-flex align-items-center mb-3">
                <span class="badge me-2" style="background:#FFD600;width:14px;height:14px;">&nbsp;</span>
                Олег
                <button class="btn btn-link btn-sm ms-auto edit-member-btn"><i class="bi bi-pencil"></i></button>
              </li>
              <li class="d-flex align-items-center mb-3">
                <span class="badge me-2" style="background:#4CB1FF;width:14px;height:14px;">&nbsp;</span>
                Маша
                <button class="btn btn-link btn-sm ms-auto edit-member-btn"><i class="bi bi-pencil"></i></button>
              </li>
            </ul>
            <div class="text-center">
              <button class="btn btn-success rounded-pill px-4 py-2">Добавить участника</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно добавления участника -->
    <div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-3">
                <div class="modal-header border-0 pb-0">
                    <h2 class="modal-title w-100 text-center fw-bold fs-2" id="addMemberModalLabel">Добавить участника</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <form>
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-lg" placeholder="Имя" style="border-radius:14px;">
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control form-control-lg" placeholder="Email" style="border-radius:14px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Цвет</label>
                            <div class="d-flex gap-3 justify-content-center flex-wrap">
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle color-choice selected" style="width:56px;height:56px;background:#6C7BFF;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;"></div>
                                </div>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle color-choice" style="width:56px;height:56px;background:#FF7EB3;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;"></div>
                                </div>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle color-choice" style="width:56px;height:56px;background:#FFD600;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;"></div>
                                </div>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle color-choice" style="width:56px;height:56px;background:#4CB1FF;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;"></div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn w-100 py-2" style="background:#A6E6B5; border-radius:16px; font-size:1.5rem;">Добавить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования участника -->
    <div class="modal fade" id="editMemberModal" tabindex="-1" aria-labelledby="editMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-3">
                <div class="modal-header border-0 pb-0">
                    <h2 class="modal-title w-100 text-center fw-bold fs-2" id="editMemberModalLabel">Редактировать участника</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <form>
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-lg" placeholder="Имя" style="border-radius:14px;">
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control form-control-lg" placeholder="Email" style="border-radius:14px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Цвет</label>
                            <div class="d-flex gap-3 justify-content-center flex-wrap">
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle" style="width:56px;height:56px;background:#6C7BFF;display:flex;align-items:center;justify-content:center;font-size:2rem;"></div>
                                </div>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle" style="width:56px;height:56px;background:#FF7EB3;display:flex;align-items:center;justify-content:center;font-size:2rem;"></div>
                                </div>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle" style="width:56px;height:56px;background:#FFD600;display:flex;align-items:center;justify-content:center;font-size:2rem;"></div>
                                </div>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="rounded-circle" style="width:56px;height:56px;background:#4CB1FF;display:flex;align-items:center;justify-content:center;font-size:2rem;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-danger px-4" style="border-radius:14px;">Удалить</button>
                            <button type="submit" class="btn" style="background:#A6E6B5; border-radius:16px; font-size:1.2rem; min-width:120px;">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка: Экспорт данных -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-4" style="min-width:320px;">
                <div class="modal-header border-0 pb-0 align-items-center justify-content-between">
                    <h2 class="modal-title w-100 text-center fw-bold fs-2" id="exportModalLabel">Экспорт данных</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-3 pb-0 d-flex flex-column gap-3">
                    <button id="exportPdfBtn" class="btn btn-outline-primary w-100 py-3" style="font-size:1.2rem;">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Экспорт в PDF
                    </button>
                    <button id="exportExcelBtn" class="btn btn-outline-success w-100 py-3" style="font-size:1.2rem;">
                        <i class="bi bi-file-earmark-excel me-2"></i>Экспорт в Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/fonts/Roboto/Roboto-normal.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mainTitle = document.getElementById('mainTitle');
            let currentGroup = 'my'; // 'my' или 'family'
            let origRenderCategories;
            let origRenderHistory;
            function updateMainTitle() {
                mainTitle.innerHTML = (currentGroup === 'my' ? 'Мои финансы' : 'Семья') + ' <i class="bi bi-chevron-down ms-2"></i>';
            }

            
            const dataSets = {
                my: {
                    categories: [],
                    chart: {
                        labels: [],
                        data: [],
                        colors: []
                    },
                    history: {
                        expense: { week: [], day: [], month: [], year: [], custom: [] },
                        income: { week: [], day: [], month: [], year: [], custom: [] }
                    }
                },
                family: {
                    members: [], // Новый массив участников
                    categories: [],
                    chart: {
                        labels: [],
                        data: [],
                        colors: []
                    },
                    history: { expense: { week: [], day: [], month: [], year: [], custom: [] }, income: { week: [], day: [], month: [], year: [], custom: [] } }
                }
            };

            const icons = [
                {icon: 'basket2-fill', label: 'Продукты', color: '#6C7BFF'},
                {icon: 'bus-front-fill', label: 'Транспорт', color: '#3DC1C7'},
                {icon: 'cash-stack', label: 'Зарплата', color: '#FFD600'},
                {icon: 'gift-fill', label: 'Подарок', color: '#FF7EB3'},
                {icon: 'cup-hot-fill', label: 'Кафе', color: '#7ED957'},
                {icon: 'bag-fill', label: 'Шоппинг', color: '#A259FF'},
                {icon: 'emoji-smile-fill', label: 'Дети', color: '#FFB86B'},
                {icon: 'balloon-fill', label: 'Досуг', color: '#43E97B'},
                {icon: 'piggy-bank-fill', label: 'Сбережения', color: '#38B6FF'},
                {icon: 'star-fill', label: 'Другое', color: '#FF6B6B'}
            ];

            
            loadCategoriesFromStorage();
            loadHistoryFromStorage();

            
            function renderCategories() {
                const catBlock = document.getElementById('categoriesList');
                catBlock.innerHTML = '';
                dataSets[currentGroup].categories.forEach((cat, i) => {
                    catBlock.innerHTML += `<li class="d-flex align-items-center mb-3">
                      <span class="badge me-2" style="background:${cat.color};width:16px;height:16px;">&nbsp;</span>
                      <i class="bi bi-${cat.icon} me-2 cat-icon" data-idx="${i}" style="color:${cat.color};font-size:1.2rem;cursor:pointer;"></i>
                      <span class="cat-name expanded" style="display:inline-block;max-width:200px;opacity:1;overflow:hidden;white-space:nowrap;transition:max-width 0.3s,opacity 0.3s;">
                        ${cat.name}
                        ${cat.limit ? `<span class='d-block text-muted small' style='font-size:0.95em;'>Лимит: ${Number(cat.limit).toLocaleString('ru-RU')} rub</span>` : ''}
                      </span>
                      <button class="btn btn-link btn-sm ms-auto edit-category-btn"><i class="bi bi-pencil"></i></button>
                    </li>`;
                });
                updateChartData();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                
                setTimeout(() => {
                  document.querySelectorAll('.cat-icon').forEach(icon => {
                    icon.onclick = function() {
                      const li = this.closest('li');
                      const nameSpan = li.querySelector('.cat-name');
                      if (nameSpan.classList.contains('expanded')) {
                        nameSpan.classList.remove('expanded');
                      } else {
                        nameSpan.classList.add('expanded');
                      }
                    };
                  });
                }, 0);
            }

            
            let budgetChart;
            function renderChart(type = 'pie') {
                const chartData = dataSets[currentGroup].chart;
                const ctx = document.getElementById('budgetChart').getContext('2d');
                if (budgetChart) budgetChart.destroy();
                let labels = chartData.labels;
                let data = chartData.data;
                let colors = chartData.colors;
                let isEmpty = !data || !data.length;
                if (isEmpty) {
                    labels = ['Нет данных'];
                    data = [1];
                    colors = ['#e9ecef'];
                } else {
                    
                }
                budgetChart = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (isEmpty) return '';
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        label += context.raw.toLocaleString('ru-RU') + ' ₽';
                                        return label;
                                    }
                                }
                            },
                            datalabels: type === 'pie' ? {
                                color: '#fff',
                                font: { weight: 'bold', size: 14 },
                                display: !isEmpty,
                                formatter: function(value, context) {
                                    if (isEmpty) return '';
                                    const dataArr = context.chart.data.datasets[0].data;
                                    const sum = dataArr.reduce((a, b) => a + b, 0);
                                    const percent = sum ? (value / sum * 100).toFixed(1) : 0;
                                    return percent + '%';
                                }
                            } : {
                                display: false
                            }
                        },
                        scales: type === 'bar' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('ru-RU') + ' ₽';
                                    }
                                }
                            }
                        } : {}
                    },
                    plugins: [ChartDataLabels]
                });
            }

           
            function updateChartData() {
                const categories = dataSets[currentGroup].categories.filter(c => c.type === currentType);
                const labels = [];
                const data = [];
                const colors = [];
                (categories || []).forEach(cat => {
                    let sum = 0;
                    (dataSets[currentGroup].history[currentType][currentPeriod] || []).forEach(day => {
                        (day.items || []).forEach(item => {
                            if (item.cat === cat.name) sum += item.sum;
                        });
                    });
                    if (sum > 0) {
                        labels.push(cat.name);
                        data.push(sum);
                        colors.push(cat.color);
                    }
                });
                dataSets[currentGroup].chart.labels = labels;
                dataSets[currentGroup].chart.data = data;
                dataSets[currentGroup].chart.colors = colors;
            }

            // --- История ---
            let currentType = 'expense';
            let currentPeriod = 'week';
            let sortDesc = true;
            function renderHistory(type, period, sortDesc = true) {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                const data = dataSets[currentGroup].history[type][period] || [];
                let total = 0;
                let sorted = [...data];
                if (!sortDesc) sorted.reverse();
                sorted.forEach((day, dayIdx) => {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'text-muted small mb-1';
                    dateDiv.textContent = formatDate(day.date);
                    list.appendChild(dateDiv);
                    day.items.forEach((item, itemIdx) => {
                        total += item.sum;
                        const row = document.createElement('div');
                        row.className = 'd-flex align-items-center mb-2';
                        row.innerHTML = `
                            <span class="me-2 d-flex align-items-center justify-content-center" style="color:${item.color};width:32px;height:32px;"><i class="bi bi-${item.icon} fs-5"></i></span>
                            <div class="flex-grow-1">
                                <div>${item.cat}</div>
                                ${item.sub ? `<div class='small text-muted'>${item.sub}</div>` : ''}
                            </div>
                            <div class="ms-auto fw-bold">${type==='income'?'+':'-'}${item.sum.toLocaleString('ru-RU')} ₽</div>
                            <button class="btn btn-link btn-sm ms-2 edit-operation-btn" data-day-idx="${dayIdx}" data-item-idx="${itemIdx}"><i class="bi bi-pencil"></i></button>
                        `;
                        // Диагностика:
                        row.onclick = function(e) {
                          console.log('ROW CLICK', e.target);
                        };
                        list.appendChild(row);
                    });
                });
                document.getElementById('historyTotal').textContent = `${total.toLocaleString('ru-RU')} ₽`;
                updateChartData();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
            }

            
            function renderFamilyMembers() {
                const block = document.getElementById('familyMembersBlock');
                const list = document.getElementById('familyMembersList');
                if (currentGroup === 'family') {
                    block.classList.remove('d-none');
                    list.innerHTML = '';
                    (dataSets.family.members || []).forEach((m, idx) => {
                        list.innerHTML += `<li class="d-flex align-items-center mb-3"><span class="badge me-2" style="background:${m.color};width:14px;height:14px;">&nbsp;</span>${m.name} <button class="btn btn-link btn-sm ms-auto edit-member-btn" data-idx="${idx}"><i class="bi bi-pencil"></i></button></li>`;
                    });
                    // Кнопки редактирования
                    document.querySelectorAll('.edit-member-btn').forEach(btn => {
                        btn.onclick = function(e) {
                            e.preventDefault();
                            const idx = +btn.getAttribute('data-idx');
                            const modal = new bootstrap.Modal(document.getElementById('editMemberModal'));
                            // Заполнить форму
                            const form = document.querySelector('#editMemberModal form');
                            form.querySelector('input[type="text"]').value = dataSets.family.members[idx].name;
                            form.querySelector('input[type="email"]').value = dataSets.family.members[idx].email || '';
                            // Цвет
                            const color = dataSets.family.members[idx].color;
                            form.querySelectorAll('.rounded-circle').forEach(el => {
                                if (el.style.background === color) el.classList.add('selected');
                                else el.classList.remove('selected');
                            });
                            form.setAttribute('data-edit-idx', idx);
                            modal.show();
                        };
                    });
                    // Кнопки удаления
                    document.querySelectorAll('.remove-member-btn').forEach(btn => {
                        btn.onclick = function(e) {
                            e.preventDefault();
                            const idx = +btn.getAttribute('data-idx');
                            if (confirm('Удалить участника?')) {
                                dataSets.family.members.splice(idx, 1);
                                saveFamilyMembersToStorage();
                                renderFamilyMembers();
                            }
                        };
                    });
                } else {
                    block.classList.add('d-none');
                }
            }
            function rerenderAll() {
                updateMainTitle();
                renderCategories();
                renderFamilyMembers();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                renderHistory(currentType, currentPeriod, sortDesc);
            }

            
            window.selectOption = function(option) {
                currentGroup = (option === 'Семья') ? 'family' : 'my';
                rerenderAll();
                var modal = bootstrap.Modal.getInstance(document.getElementById('financeModal'));
                modal.hide();
            }

            
            document.querySelectorAll('.chart-type-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    renderChart(this.dataset.type);
                });
            });

            
            document.getElementById('tab-expense').onclick = function() {
                currentType = 'expense';
                this.classList.add('active');
                document.getElementById('tab-income').classList.remove('active');
                renderHistory(currentType, currentPeriod, sortDesc);
            };
            document.getElementById('tab-income').onclick = function() {
                currentType = 'income';
                this.classList.add('active');
                document.getElementById('tab-expense').classList.remove('active');
                renderHistory(currentType, currentPeriod, sortDesc);
            };
            document.querySelectorAll('#historyPeriods .nav-link').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('#historyPeriods .nav-link').forEach(b=>b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.getAttribute('data-period');
                    renderHistory(currentType, currentPeriod, sortDesc);
                }
            });
            document.getElementById('sortToggle').onclick = function() {
                sortDesc = !sortDesc;
                this.innerHTML = `По дате <i class="bi bi-chevron-${sortDesc?'down':'up'}"></i>`;
                renderHistory(currentType, currentPeriod, sortDesc);
            };
            document.getElementById('periodPrev').onclick = function() {
                
            };
            document.getElementById('periodNext').onclick = function() {
                
            };

           
            function formatDate(dateStr) {
                const months = ['января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря'];
                const d = new Date(dateStr);
                return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
            }

            
            rerenderAll();

           
            document.getElementById('addOperationBtn')?.addEventListener('click', function() {
              const modal = new bootstrap.Modal(document.getElementById('addOperationModal'));
              modal.show();
            });
            document.getElementById('addCategoryBtn')?.addEventListener('click', function() {
              const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
              modal.show();
            });

            
            function bindEditCategoryBtns() {
              console.log('bindEditCategoryBtns called, currentGroup:', currentGroup);
              document.querySelectorAll('.edit-category-btn').forEach((btn, idx) => {
                console.log(`Found edit button ${idx}`);
                btn.onclick = function(e) {
                  console.log('Edit button clicked');
                  e.preventDefault();
                  e.stopPropagation();
                  if (typeof bootstrap === 'undefined') {
                    console.error('Bootstrap не инициализирован');
                    return;
                  }
                  const modalElement = document.getElementById('editCategoryModal');
                  if (!modalElement) {
                    console.error('Модальное окно редактирования не найдено');
                    return;
                  }
                  const modal = new bootstrap.Modal(modalElement);
                  const cat = dataSets[currentGroup].categories[idx];
                  if (!cat) {
                    console.error('Категория не найдена');
                    return;
                  }
                  const form = modalElement.querySelector('form');
                  if (!form) {
                    console.error('Форма не найдена в модальном окне');
                    return;
                  }
                  form.querySelector('input[type="text"]').value = cat.name;
                  form.querySelector('input[name="editCatType"][id="editCatExpense"]').checked = cat.type === 'expense';
                  form.querySelector('input[name="editCatType"][id="editCatIncome"]').checked = cat.type === 'income';
                  const iconBlock = form.querySelector('.mb-3 label.form-label + .d-flex');
                  if (iconBlock) {
                    iconBlock.innerHTML = icons.map((ic, i) => `
                      <div class="d-flex flex-column align-items-center">
                        <div class="rounded-circle icon-choice${cat.icon===ic.icon?' selected':''}" data-icon="${ic.icon}" data-color="${ic.color}" style="width:56px;height:56px;background:${ic.color};display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;">
                          <i class="bi bi-${ic.icon}"></i>
                        </div>
                        <div class="small">${ic.label}</div>
                      </div>
                    `).join('');
                    iconBlock.querySelectorAll('.icon-choice').forEach(el => {
                      el.onclick = function() {
                        iconBlock.querySelectorAll('.icon-choice').forEach(e=>e.classList.remove('selected'));
                        this.classList.add('selected');
                      };
                    });
                  }
                  const limitInput = form.querySelector('input[type="number"]');
                  if (limitInput) {
                    limitInput.value = cat.limit || '';
                  }
                  form.setAttribute('data-edit-idx', idx);
                  modal.show();
                };
              });
            }
            
            bindEditCategoryBtns();
            
            if (!origRenderCategories) origRenderCategories = renderCategories;
            renderCategories = function() {
                origRenderCategories();
                bindEditCategoryBtns();
            }

            
            function setupOperationTypeTabs() {
              const modal = document.getElementById('addOperationModal');
              if (!modal) return;
              const tabs = modal.querySelectorAll('.nav-link');
              tabs.forEach(tab => {
                tab.onclick = function(e) {
                  e.preventDefault();
                  tabs.forEach(t => t.classList.remove('active'));
                  this.classList.add('active');
                  
                };
              });
            }
            setupOperationTypeTabs();

            
            document.querySelectorAll('.bi-bell').forEach(bell => {
              bell.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('notificationsModal'));
                modal.show();
              });
            });

            
            function bindEditOperationBtns() {
              console.log('bindEditOperationBtns called, currentGroup:', currentGroup);
              document.querySelectorAll('.edit-operation-btn').forEach((btn) => {
                btn.onclick = function(e) {
                  e.preventDefault();
                  const dayIdx = +btn.getAttribute('data-day-idx');
                  const itemIdx = +btn.getAttribute('data-item-idx');
                  const foundDay = dataSets[currentGroup].history[currentType][currentPeriod][dayIdx];
                  if (!foundDay) return;
                  const foundItem = foundDay.items[itemIdx];
                  if (!foundItem) return;
                  // Открыть модалку и заполнить поля
                  const modal = new bootstrap.Modal(document.getElementById('editOperationModal'));
                  const form = document.querySelector('#editOperationModal form');
                  // Категория
                  const select = form.querySelector('select');
                  select.innerHTML = '<option selected>Категория</option>' +
                    dataSets[currentGroup].categories.filter(c => c.type === currentType).map(cat =>
                      `<option value="${cat.name}"${cat.name===foundItem.cat?' selected':''}>${cat.name}</option>`
                    ).join('');
                  // Тип
                  form.querySelector('input#editOpExpense').checked = currentType === 'expense';
                  form.querySelector('input#editOpIncome').checked = currentType === 'income';
                  // Сумма
                  form.querySelector('input[type="number"]').value = foundItem.sum;
                  // Дата
                  form.querySelector('input[type="date"]').value = foundDay.date;
                  // Комментарий
                  form.querySelector('input[type="text"]').value = foundItem.sub || '';
                  // --- Новый блок: участник ---
                  let memberSelect = form.querySelector('select[name="member"]');
                  if (!memberSelect) {
                    memberSelect = document.createElement('select');
                    memberSelect.className = 'form-select form-control-lg mb-3';
                    memberSelect.name = 'member';
                    select.parentElement.parentElement.insertBefore(memberSelect, select.parentElement);
                  }
                  if (currentGroup === 'family') {
                    memberSelect.innerHTML = '<option value="">Участник</option>' +
                      (dataSets.family.members || []).map((m, idx) => `<option value="${idx}"${foundItem.member===m.name?' selected':''}>${m.name}</option>`).join('');
                    memberSelect.style.display = '';
                  } else {
                    memberSelect.innerHTML = '';
                    memberSelect.style.display = 'none';
                  }
                  // Сохраняем индексы для сохранения
                  form.setAttribute('data-edit-day-idx', dayIdx);
                  form.setAttribute('data-edit-item-idx', itemIdx);
                  modal.show();
                };
              });
            }
            bindEditOperationBtns();
            
            // Объявить origRenderHistoryFn один раз в самом верху (до всех функций)
            let origRenderHistoryFn;
            // Далее оставить только присваивание внутри условия
            if (!origRenderHistory) {
              origRenderHistory = renderHistory;
              origRenderHistoryFn = origRenderHistory;
              origRenderHistory = function(type, period, sortDesc = true) {
                console.log('origRenderHistory called, currentGroup:', currentGroup, 'type:', type, 'period:', period);
                origRenderHistoryFn(type, period, sortDesc);
              }
            }
            renderHistory = function(type, period, sortDesc = true) {
              console.log('renderHistory called, currentGroup:', currentGroup, 'type:', type, 'period:', period);
              origRenderHistory(type, period, sortDesc);
              setTimeout(bindEditOperationBtns, 0);
            }

            
            function bindProfileMenuBtns() {
                document.querySelectorAll('.btn-outline-primary').forEach(btn => {
                  if(btn.textContent.trim() === 'Профиль') {
                    btn.onclick = function() {
                      const modal = new bootstrap.Modal(document.getElementById('profileInfoModal'));
                      modal.show();
                      const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
                      if(profileModal) profileModal.hide();
                    };
                  }
                  if(btn.textContent.trim() === 'Семья') {
                    btn.onclick = function() {
                      const modal = new bootstrap.Modal(document.getElementById('familyModal'));
                      modal.show();
                      const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
                      if(profileModal) profileModal.hide();
                    };
                  }
                });
                document.getElementById('settingsBtn')?.addEventListener('click', function() {
                  const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
                  modal.show();
                  
                  const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
                  if(profileModal) profileModal.hide();
                });
            }
            
            document.getElementById('profileModal')?.addEventListener('show.bs.modal', bindProfileMenuBtns);

            
            const notificationsModal = document.getElementById('notificationsModal');

            
            document.querySelector('#familyModal .btn-success')?.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
                modal.show();
                
                const familyModal = bootstrap.Modal.getInstance(document.getElementById('familyModal'));
                if(familyModal) familyModal.hide();
            });

           
            document.querySelectorAll('#familyModal .edit-member-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.preventDefault();
                    const modal = new bootstrap.Modal(document.getElementById('editMemberModal'));
                    modal.show();
                    
                    const familyModal = bootstrap.Modal.getInstance(document.getElementById('familyModal'));
                    if(familyModal) familyModal.hide();
                };
            });

            
            const savedTheme = localStorage.getItem('financeTheme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);

            
            document.querySelector('.theme-toggle-btn')?.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('financeTheme', newTheme);
                updateThemeButton(newTheme);
            });

            
            document.querySelector('.contact-btn')?.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('contactModal'));
                modal.show();
            });

           
            function logoutUser() {
                
                fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        
                    },
                    credentials: 'same-origin'
                })
                .then(() => {
                    
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                    
                    window.location.href = 'index.html';
                })
                .catch(() => {
                    window.location.href = 'index.html';
                });
            }
            
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('button, .btn');
                if (btn && btn.textContent.replace(/\s+/g, '').includes('Выйти')) {
                    e.preventDefault();
                    logoutUser();
                }
            });

            
            let cachedUser = null;

           
            const profileModal = document.getElementById('profileInfoModal');
            profileModal.addEventListener('show.bs.modal', function() {
                
                if (cachedUser) {
                    const name = cachedUser.name || '';
                    const email = cachedUser.email || '';
                    document.getElementById('profileNameTitle').textContent = name || 'Пожалуйста, введите свое имя';
                    document.getElementById('profileNameInput').value = name;
                    document.getElementById('profileEmailTitle').textContent = email;
                    document.getElementById('profileEmailInput').value = email;
                } else {
                    
                    fetch('/api/user', {
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        },
                        credentials: 'same-origin'
                    })
                    .then(res => res.json())
                    .then(data => {
                        cachedUser = data;
                        const name = data.name || '';
                        const email = data.email || '';
                        document.getElementById('profileNameTitle').textContent = name || 'Пожалуйста, введите свое имя';
                        document.getElementById('profileNameInput').value = name;
                        document.getElementById('profileEmailTitle').textContent = email;
                        document.getElementById('profileEmailInput').value = email;
                    });
                }
            });
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('profileNameInput').value.trim();
                fetch('/api/profile', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ name })
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('profileNameTitle').textContent = data.user.name || 'Пожалуйста, введите свое имя';
                    
                    if (cachedUser) cachedUser.name = data.user.name;
                    
                });
            });

            
            fetch('/api/user', {
                headers: {
                    'Accept': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(res => res.json())
            .then(data => {
                const name = data.name || 'Пожалуйста, введите свое имя';
                const profileTitle = document.getElementById('profileNameTitle');
                if (profileTitle) profileTitle.textContent = name;
                window.currentUserName = name;
                
                cachedUser = data;
            });

            
            (function() {
                
                const icons = [
                    {icon: 'basket2-fill', label: 'Продукты', color: '#6C7BFF'},
                    {icon: 'bus-front-fill', label: 'Транспорт', color: '#3DC1C7'},
                    {icon: 'cash-stack', label: 'Зарплата', color: '#FFD600'},
                    {icon: 'gift-fill', label: 'Подарок', color: '#FF7EB3'},
                    {icon: 'cup-hot-fill', label: 'Кафе', color: '#7ED957'},
                    {icon: 'bag-fill', label: 'Шоппинг', color: '#A259FF'},
                    {icon: 'emoji-smile-fill', label: 'Дети', color: '#FFB86B'},
                    {icon: 'balloon-fill', label: 'Досуг', color: '#43E97B'},
                    {icon: 'piggy-bank-fill', label: 'Сбережения', color: '#38B6FF'},
                    {icon: 'star-fill', label: 'Другое', color: '#FF6B6B'}
                ];
                
                function renderIconChoices() {
                    const iconBlock = document.querySelector('#addCategoryModal .mb-3 label.form-label + .d-flex');
                    if (!iconBlock) return;
                    iconBlock.innerHTML = icons.map((ic, idx) => `
                        <div class="d-flex flex-column align-items-center">
                            <div class="rounded-circle icon-choice${idx===0?' selected':''}" data-icon="${ic.icon}" data-color="${ic.color}" style="width:56px;height:56px;background:${ic.color};display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;">
                                <i class="bi bi-${ic.icon}"></i>
                            </div>
                            <div class="small">${ic.label}</div>
                        </div>
                    `).join('');
                    
                    iconBlock.querySelectorAll('.icon-choice').forEach(el => {
                        el.onclick = function() {
                            iconBlock.querySelectorAll('.icon-choice').forEach(e=>e.classList.remove('selected'));
                            this.classList.add('selected');
                            const label = this.parentElement.querySelector('.small')?.textContent;
                            if (label) {
                                document.querySelector('#addCategoryModal input[type="text"]').value = label;
                            }
                        };
                    });
                }
                
                document.getElementById('addCategoryModal').addEventListener('show.bs.modal', function() {
                  renderIconChoices();
                  
                  const iconBlock = document.querySelector('#addCategoryModal .mb-3 label.form-label + .d-flex');
                  if (iconBlock) {
                    iconBlock.querySelectorAll('.icon-choice').forEach(icon => {
                      icon.onclick = function() {
                        iconBlock.querySelectorAll('.icon-choice').forEach(e=>e.classList.remove('selected'));
                        this.classList.add('selected');
                        const label = this.parentElement.querySelector('.small')?.textContent;
                        if (label) {
                          document.querySelector('#addCategoryModal input[type="text"]').value = label;
                        }
                      };
                    });
                  }
                });
                
                document.querySelector('#addCategoryModal form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const name = this.querySelector('input[type="text"]').value.trim();
                    if (!name) return;
                    const type = this.querySelector('input[name="catType"]:checked').id === 'catExpense' ? 'expense' : 'income';
                    
                    let iconEl = this.querySelector('.icon-choice.selected');
                    let icon = iconEl ? iconEl.getAttribute('data-icon') : icons[0].icon;
                    let color = iconEl ? iconEl.getAttribute('data-color') : null;
                    
                    if (!color) {
                        const usedColors = dataSets[currentGroup].categories.map(c => c.color);
                        const palette = icons.map(ic => ic.color);
                        color = palette.find(c => !usedColors.includes(c));
                        if (!color) {
                            
                            color = palette[Math.floor(Math.random() * palette.length)];
                        }
                    }
                    dataSets[currentGroup].categories.push({ name, icon, color, type });
                    saveCategoriesToStorage();
                    renderCategories();
                    updateChartData();
                    renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                    
                    bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                    this.reset();
                });
            })();

           
            function loadCategoriesFromStorage() {
                ['my', 'family'].forEach(group => {
                    const saved = localStorage.getItem('categories_' + group);
                    if (saved) {
                        try {
                            dataSets[group].categories = JSON.parse(saved);
                        } catch(e) {}
                    }
                });
            }
            function saveCategoriesToStorage() {
                localStorage.setItem('categories_my', JSON.stringify(dataSets.my.categories));
                localStorage.setItem('categories_family', JSON.stringify(dataSets.family.categories));
            }

            
            function loadHistoryFromStorage() {
                ['my', 'family'].forEach(group => {
                    const saved = localStorage.getItem('history_' + group);
                    if (saved) {
                        try {
                            dataSets[group].history = JSON.parse(saved);
                        } catch(e) {}
                    }
                });
            }
            function saveHistoryToStorage() {
                localStorage.setItem('history_my', JSON.stringify(dataSets.my.history));
                localStorage.setItem('history_family', JSON.stringify(dataSets.family.history));
            }

            
            loadCategoriesFromStorage();
            loadHistoryFromStorage();

            
            (function() {
                const form = document.querySelector('#addOperationModal form');
                if (!form) return;
                let memberSelect = form.querySelector('select[name="member"]');
                if (!memberSelect) {
                    memberSelect = document.createElement('select');
                    memberSelect.className = 'form-select form-control-lg mb-3';
                    memberSelect.name = 'member';
                    memberSelect.innerHTML = '<option value="">Участник</option>';
                    form.prepend(memberSelect);
                }
                // При открытии модалки — обновлять список участников и категорий
                document.getElementById('addOperationModal').addEventListener('show.bs.modal', function() {
                    // Участники
                    if (currentGroup === 'family') {
                        memberSelect.innerHTML = '<option value="">Участник</option>' +
                            (dataSets.family.members || []).map((m, idx) => `<option value="${idx}">${m.name}</option>`).join('');
                        memberSelect.style.display = '';
                    } else {
                        memberSelect.innerHTML = '';
                        memberSelect.style.display = 'none';
                    }
                    // Категории — всегда актуальны для текущей группы и типа
                    const select = form.querySelector('select:not([name="member"])');
                    select.innerHTML = '<option selected>Категория</option>' +
                        (dataSets[currentGroup].categories || [])
                            .filter(c => c.type === currentType)
                            .map(cat => `<option value="${cat.name}">${cat.name}</option>`)
                            .join('');
                });
                // Изменяем обработчик submit
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const catSelect = form.querySelector('select:not([name="member"])');
                    const catName = catSelect.value;
                    if (!catName || catName === 'Категория') return;
                    const sumInput = form.querySelector('input[type="number"]');
                    const sum = parseFloat(sumInput.value);
                    if (!sum || sum <= 0) return;
                    const dateInput = form.querySelector('input[type="date"]');
                    const date = dateInput.value || (new Date()).toISOString().slice(0,10);
                    const commentInput = form.querySelector('input[type="text"]');
                    const comment = commentInput.value.trim();
                    const cat = dataSets[currentGroup].categories.find(c => c.name === catName);
                    if (!cat) return;
                    let periodArr = dataSets[currentGroup].history[currentType][currentPeriod];
                    let day = periodArr.find(d => d.date === date);
                    if (!day) {
                        day = { date, items: [] };
                        periodArr.push(day);
                    }
                    // --- Главное отличие: участник не обязателен ---
                    let memberIdx = memberSelect && memberSelect.value !== '' ? +memberSelect.value : null;
                    let member = null;
                    if (currentGroup === 'family' && memberIdx !== null && dataSets.family.members[memberIdx]) {
                        member = dataSets.family.members[memberIdx];
                    }
                    const newItem = {
                        cat: cat.name,
                        icon: cat.icon,
                        color: cat.color,
                        sum: sum,
                        sub: comment
                    };
                    if (member) {
                        newItem.member = member.name;
                        newItem.memberColor = member.color;
                    }
                    day.items.push(newItem);
                    checkBudgetLimit(cat.name);
                    updateChartData();
                    renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                    renderHistory(currentType, currentPeriod, true);
                    saveHistoryToStorage();
                    if (typeof updateFamilyBudgetUI === 'function') updateFamilyBudgetUI();
                    bootstrap.Modal.getInstance(document.getElementById('addOperationModal')).hide();
                    form.reset();
                }, true);
            })();

            
            function updateThemeButton(theme) {
                const themeBtn = document.querySelector('.theme-toggle-btn');
                const themeText = themeBtn.querySelector('.theme-text');
                if (theme === 'dark') {
                    themeBtn.innerHTML = '<i class="bi bi-sun-fill fs-3"></i> <span class="theme-text">Светлая тема</span>';
                    themeBtn.style.background = '#e5e5e5';
                    themeBtn.style.color = '#222';
                } else {
                    themeBtn.innerHTML = '<i class="bi bi-moon-stars-fill fs-3"></i> <span class="theme-text">Темная тема</span>';
                    themeBtn.style.background = '#333';
                    themeBtn.style.color = '#fff';
                }
            }

            
            (function() {
              const form = document.querySelector('#editCategoryModal form');
              if (!form) return;
              
              form.addEventListener('submit', function(e) {
                e.preventDefault();
                const idx = +form.getAttribute('data-edit-idx');
                if (isNaN(idx)) return;
                const name = form.querySelector('input[type="text"]').value.trim();
                const type = form.querySelector('input[name="editCatType"]:checked').id === 'editCatExpense' ? 'expense' : 'income';
                const iconEl = form.querySelector('.icon-choice.selected');
                const icon = iconEl ? iconEl.getAttribute('data-icon') : icons[0].icon;
                const color = iconEl ? iconEl.getAttribute('data-color') : icons[0].color;
                const limit = form.querySelector('input[type="number"]').value;
                
                dataSets[currentGroup].categories[idx] = { name, icon, color, type, limit };
                saveCategoriesToStorage();
                renderCategories();
                updateChartData();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                
                Object.values(dataSets[currentGroup].history).forEach(typeObj => {
                  Object.values(typeObj).forEach(periodArr => {
                    periodArr.forEach(day => {
                      day.items.forEach(item => {
                        if (item.cat === name) {
                          item.icon = icon;
                          item.color = color;
                        }
                      });
                    });
                  });
                });
                renderHistory(currentType, currentPeriod, true);
                saveHistoryToStorage();
                bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
              });
              
              form.querySelector('.btn-danger').onclick = function(e) {
                e.preventDefault();
                const idx = +form.getAttribute('data-edit-idx');
                if (isNaN(idx)) return;
                const cat = dataSets[currentGroup].categories[idx];
                
                Object.values(dataSets[currentGroup].history).forEach(typeObj => {
                  Object.values(typeObj).forEach(periodArr => {
                    periodArr.forEach(day => {
                      day.items = day.items.filter(item => item.cat !== cat.name);
                    });
                  });
                });
                
                dataSets[currentGroup].categories.splice(idx, 1);
                saveCategoriesToStorage();
                renderCategories();
                updateChartData();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                renderHistory(currentType, currentPeriod, true);
                saveHistoryToStorage();
                bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
              };
            })();

            // Открытие модалки экспорта по кнопке "Скачать"
            document.getElementById('downloadChartBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('exportModal'));
                modal.show();
            });

            // Экспорт в PDF
            document.getElementById('exportPdfBtn').addEventListener('click', function() {
                const canvas = document.getElementById('budgetChart');
                const imgData = canvas.toDataURL('image/png');
                const a4Width = 1122;
                const a4Height = 793;
                const margin = 30;
                // Диаграмма занимает 50% высоты листа
                let imgHeight = a4Height * 0.5;
                let imgWidth = imgHeight * (canvas.width / canvas.height);
                if (imgWidth > a4Width - margin * 2) {
                    imgWidth = a4Width - margin * 2;
                    imgHeight = imgWidth * (canvas.height / canvas.width);
                }
                const imgX = (a4Width - imgWidth) / 2;
                const imgY = margin;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [a4Width, a4Height]
                });
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);
                // Легенда: цветной круг + сумма
                const legendY = imgY + imgHeight + 40;
                const legendX = margin + 10;
                const legendLineHeight = 38;
                const circleSize = 22;
                const categories = dataSets[currentGroup].categories.filter(c => c.type === currentType);
                let legendI = 0;
                categories.forEach(cat => {
                    // Цветной круг
                    pdf.setFillColor(cat.color || '#888');
                    pdf.circle(legendX + circleSize / 2, legendY + legendI * legendLineHeight + circleSize / 2, circleSize / 2, 'F');
                    // Сумма
                    let sum = 0;
                    (dataSets[currentGroup].history[currentType][currentPeriod] || []).forEach(day => {
                        (day.items || []).forEach(item => {
                            if (item.cat === cat.name) sum += item.sum;
                        });
                    });
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(18);
                    pdf.text(sum ? (sum.toLocaleString('ru-RU') + ' rub') : '', legendX + circleSize + 18, legendY + legendI * legendLineHeight + circleSize - 6);
                    legendI++;
                });
                pdf.save('diagram.pdf');
                bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
            });

            // Экспорт в Excel
            document.getElementById('exportExcelBtn').addEventListener('click', function() {
                const wb = XLSX.utils.book_new();
                // Лист с категориями
                const categoriesData = dataSets[currentGroup].categories
                    .filter(c => c.type === currentType)
                    .map(cat => {
                        let sum = 0;
                        (dataSets[currentGroup].history[currentType][currentPeriod] || []).forEach(day => {
                            (day.items || []).forEach(item => {
                                if (item.cat === cat.name) sum += item.sum;
                            });
                        });
                        return {
                            'Категория': cat.name,
                            'Сумма': sum,
                            'Тип': cat.type === 'expense' ? 'Расход' : 'Доход',
                            'Лимит': cat.limit || ''
                        };
                    });
                const wsCategories = XLSX.utils.json_to_sheet(categoriesData);
                XLSX.utils.book_append_sheet(wb, wsCategories, "Категории");
                // Лист с месячной статистикой
                const monthlyData = [];
                const months = ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'];
                dataSets[currentGroup].categories
                    .filter(c => c.type === currentType)
                    .forEach(cat => {
                        const row = { 'Категория': cat.name };
                        months.forEach((month, idx) => {
                            let sum = 0;
                            (dataSets[currentGroup].history[currentType]['month'] || []).forEach(day => {
                                const d = new Date(day.date);
                                if (d.getMonth() === idx) {
                                    (day.items || []).forEach(item => {
                                        if (item.cat === cat.name) sum += item.sum;
                                    });
                                }
                            });
                            row[month] = sum;
                        });
                        monthlyData.push(row);
                    });
                const wsMonthly = XLSX.utils.json_to_sheet(monthlyData);
                XLSX.utils.book_append_sheet(wb, wsMonthly, "Месячная статистика");
                // Лист с транзакциями
                const transactionsData = [];
                (dataSets[currentGroup].history[currentType][currentPeriod] || []).forEach(day => {
                    day.items.forEach(item => {
                        transactionsData.push({
                            'Дата': formatDate(day.date),
                            'Категория': item.cat,
                            'Сумма': item.sum,
                            'Комментарий': item.sub || ''
                        });
                    });
                });
                const wsTransactions = XLSX.utils.json_to_sheet(transactionsData);
                XLSX.utils.book_append_sheet(wb, wsTransactions, "Транзакции");
                XLSX.writeFile(wb, 'финансовая_отчетность.xlsx');
                // Закрыть модалку после экспорта
                bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
            });

            
            function checkBudgetLimit(catName) {
                const cat = dataSets[currentGroup].categories.find(c => c.name === catName);
                if (!cat || !cat.limit) return;
                const now = new Date();
                const month = now.getMonth();
                const year = now.getFullYear();
                let spent = 0;
                (dataSets[currentGroup].history['expense']['month'] || []).forEach(day => {
                    const d = new Date(day.date);
                    if (d.getMonth() === month && d.getFullYear() === year) {
                        (day.items || []).forEach(item => {
                            if (item.cat === catName) spent += item.sum;
                        });
                    }
                });
                if (spent > Number(cat.limit)) {
                    // Проверяем, было ли уже уведомление в этом месяце по этой категории
                    let notifs = getLimitNotifications();
                    const notifKey = `${catName}_${month}_${year}`;
                    const already = notifs.some(n => n.key === notifKey);
                    if (!already) {
                        addLimitNotification(`Превышен бюджет по категории "${catName}" (${spent.toLocaleString('ru-RU')} rub из ${Number(cat.limit).toLocaleString('ru-RU')} rub)`, notifKey);
                    }
                }
            }
            // Обновить addLimitNotification для поддержки ключа
            function addLimitNotification(text, key) {
                let notifs = JSON.parse(localStorage.getItem('limitNotifications') || '[]');
                notifs.push({ text, time: new Date().toISOString(), read: false, key });
                localStorage.setItem('limitNotifications', JSON.stringify(notifs));
                updateBellIcon();
            }
            function getLimitNotifications() {
                return JSON.parse(localStorage.getItem('limitNotifications') || '[]');
            }
            function markLimitNotificationsRead() {
                let notifs = getLimitNotifications();
                notifs.forEach(n => n.read = true);
                localStorage.setItem('limitNotifications', JSON.stringify(notifs));
                updateBellIcon();
            }
            function updateBellIcon() {
                const notifs = getLimitNotifications();
                const hasUnread = notifs.some(n => !n.read);
                document.querySelectorAll('.bi-bell').forEach(bell => {
                    if (hasUnread) {
                        bell.classList.add('text-primary');
                    } else {
                        bell.classList.remove('text-primary');
                    }
                });
            }
            // Показать уведомления в модалке
            notificationsModal.addEventListener('show.bs.modal', function() {
                const body = notificationsModal.querySelector('.modal-body');
                const notifs = getLimitNotifications();
                if (!notifs.length) {
                    body.innerHTML = '<div class="w-100 text-center text-muted fs-4">здесь пока пусто</div>';
                } else {
                    body.innerHTML = '<ul class="list-unstyled w-100">' + notifs.map(n =>
                        `<li class='mb-3'><span class='fw-bold text-danger'>${n.text}</span><br><span class='text-muted small'>${new Date(n.time).toLocaleString('ru-RU')}</span></li>`
                    ).join('') + '</ul>' +
                    '<div class="text-center mt-3"><button class="btn btn-outline-secondary btn-sm" id="clearLimitNotifsBtn">Очистить</button></div>';
                }
                markLimitNotificationsRead();
            });

            // Обработчик кнопки очистки уведомлений
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'clearLimitNotifsBtn') {
                    localStorage.removeItem('limitNotifications');
                    const body = notificationsModal.querySelector('.modal-body');
                    body.innerHTML = '<div class="w-100 text-center text-muted fs-4">здесь пока пусто</div>';
                    updateBellIcon();
                }
            });

            // Обработчик закрытия модального окна
            document.querySelectorAll('.bi-bell').forEach(bell => {
                bell.addEventListener('click', function() {
                    const modal = new bootstrap.Modal(notificationsModal);
                    modal.show();
                });
            });

            // Обработчик кнопки закрытия
            notificationsModal.querySelector('.btn-close').addEventListener('click', function() {
                const modal = bootstrap.Modal.getInstance(notificationsModal);
                if (modal) {
                    modal.hide();
                }
            });

            // 1. Функции для работы с участниками семьи
            function loadFamilyMembersFromStorage() {
                const saved = localStorage.getItem('family_members');
                if (saved) {
                    try { dataSets.family.members = JSON.parse(saved); } catch(e) {}
                }
            }
            function saveFamilyMembersToStorage() {
                localStorage.setItem('family_members', JSON.stringify(dataSets.family.members));
            }

            // 2. Добавление участника
            const addMemberForm = document.querySelector('#addMemberModal form');
            // Добавим обработчик для выбора цвета
            if (addMemberForm) {
              addMemberForm.addEventListener('click', function(e) {
                const colorCircle = e.target.closest('.rounded-circle');
                // Проверяем, что клик был по цвету именно в этой модалке
                if (colorCircle && colorCircle.parentElement.parentElement.parentElement === addMemberForm) {
                  addMemberForm.querySelectorAll('.rounded-circle').forEach(el => el.classList.remove('selected'));
                  colorCircle.classList.add('selected');
                }
              });
            }
            addMemberForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = this.querySelector('input[type="text"]').value.trim();
                const email = this.querySelector('input[type="email"]').value.trim();
                const selectedColor = this.querySelector('.color-choice.selected').style.background;
                
                if (!name) return;
                
                dataSets.family.members.push({ name, email, color: selectedColor });
                saveFamilyMembersToStorage();
                renderFamilyMembers();
                
                bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
                this.reset();
            });

            // 3. Редактирование участника
            const editMemberForm = document.querySelector('#editMemberModal form');
            if (editMemberForm) {
              // Сделать выбор цвета кликабельным
              editMemberForm.addEventListener('click', function(e) {
                const colorCircle = e.target.closest('.rounded-circle');
                if (colorCircle && colorCircle.parentElement.parentElement.parentElement === editMemberForm) {
                  editMemberForm.querySelectorAll('.rounded-circle').forEach(el => el.classList.remove('selected'));
                  colorCircle.classList.add('selected');
                }
              });
              
              document.getElementById('editMemberModal').addEventListener('show.bs.modal', function() {
                const idx = +editMemberForm.getAttribute('data-edit-idx');
                const color = dataSets.family.members[idx]?.color;
                editMemberForm.querySelectorAll('.rounded-circle').forEach(el => {
                  if (el.style.background === color) el.classList.add('selected');
                  else el.classList.remove('selected');
                });
              });
              
              editMemberForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const idx = +this.getAttribute('data-edit-idx');
                const name = this.querySelector('input[type="text"]').value.trim();
                const email = this.querySelector('input[type="email"]').value.trim();
                let color = '#6C7BFF';
                this.querySelectorAll('.rounded-circle').forEach(el => {
                  if (el.classList.contains('selected')) color = el.style.background;
                });
                if (!name || isNaN(idx)) return;
                dataSets.family.members[idx] = { name, email, color };
                saveFamilyMembersToStorage();
                renderFamilyMembers();
                bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
              });
              
              editMemberForm.querySelector('.btn-danger')?.addEventListener('click', function(e) {
                e.preventDefault();
                const idx = +editMemberForm.getAttribute('data-edit-idx');
                if (isNaN(idx)) return;
                dataSets.family.members.splice(idx, 1);
                saveFamilyMembersToStorage();
                renderFamilyMembers();
                bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
              });
            }

            
            loadFamilyMembersFromStorage();
            renderFamilyMembers();

           
            function updateFamilyBudgetUI() {
                if (currentGroup !== 'family') return;
                const input = document.getElementById('familyBudgetInput');
                if (input) input.value = dataSets.family.budget || 0;
                // Прогресс
                let spent = 0;
                (dataSets.family.history['expense']['month'] || []).forEach(day => {
                    (day.items || []).forEach(item => { spent += item.sum; });
                });
                const progress = document.getElementById('familyBudgetProgress');
                if (progress) {
                    if (dataSets.family.budget > 0) {
                        const percent = Math.min(100, (spent / dataSets.family.budget * 100).toFixed(1));
                        progress.innerHTML = `<span class='badge bg-${percent>90?'danger':percent>70?'warning':'success'}'>${spent.toLocaleString('ru-RU')} / ${dataSets.family.budget.toLocaleString('ru-RU')} ₽ (${percent}%)</span>`;
                    } else {
                        progress.innerHTML = '';
                    }
                }
            }

            

           
            updateFamilyBudgetUI();

           
            (function() {
                const form = document.querySelector('#addOperationModal form');
                if (!form) return;
               
                let memberSelect = form.querySelector('select[name="member"]');
                if (!memberSelect) {
                    memberSelect = document.createElement('select');
                    memberSelect.className = 'form-select form-control-lg mb-3';
                    memberSelect.name = 'member';
                    memberSelect.innerHTML = '<option value="">Участник</option>';
                    form.prepend(memberSelect);
                }
                
                document.getElementById('addOperationModal').addEventListener('show.bs.modal', function() {
                    if (currentGroup === 'family') {
                        memberSelect.innerHTML = '<option value="">Участник</option>' +
                            (dataSets.family.members || []).map((m, idx) => `<option value="${idx}">${m.name}</option>`).join('');
                        memberSelect.style.display = '';
                    } else {
                        memberSelect.innerHTML = '';
                        memberSelect.style.display = 'none';
                    }
                });
                
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const catSelect = form.querySelector('select:not([name="member"])');
                    const catName = catSelect.value;
                    if (!catName || catName === 'Категория') return;
                    const sumInput = form.querySelector('input[type="number"]');
                    const sum = parseFloat(sumInput.value);
                    if (!sum || sum <= 0) return;
                    const dateInput = form.querySelector('input[type="date"]');
                    const date = dateInput.value || (new Date()).toISOString().slice(0,10);
                    const commentInput = form.querySelector('input[type="text"]');
                    const comment = commentInput.value.trim();
                    const cat = dataSets[currentGroup].categories.find(c => c.name === catName);
                    if (!cat) return;
                    let periodArr = dataSets[currentGroup].history[currentType][currentPeriod];
                    let day = periodArr.find(d => d.date === date);
                    if (!day) {
                        day = { date, items: [] };
                        periodArr.push(day);
                    }
                    
                    let memberIdx = memberSelect && memberSelect.value !== '' ? +memberSelect.value : null;
                    let member = null;
                    if (currentGroup === 'family' && memberIdx !== null && dataSets.family.members[memberIdx]) {
                        member = dataSets.family.members[memberIdx];
                    }
                    const newItem = {
                        cat: cat.name,
                        icon: cat.icon,
                        color: cat.color,
                        sum: sum,
                        sub: comment
                    };
                    if (member) {
                        newItem.member = member.name;
                        newItem.memberColor = member.color;
                    }
                    day.items.push(newItem);
                    checkBudgetLimit(cat.name);
                    updateChartData();
                    renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                    renderHistory(currentType, currentPeriod, true);
                    saveHistoryToStorage();
                    if (typeof updateFamilyBudgetUI === 'function') updateFamilyBudgetUI();
                    bootstrap.Modal.getInstance(document.getElementById('addOperationModal')).hide();
                    form.reset();
                }, true);
            })();

            renderHistory = function(type, period, sortDesc = true) {
                origRenderHistoryFn(type, period, sortDesc);
                
                if (currentGroup === 'family') {
                    const list = document.getElementById('historyList');
                    list.querySelectorAll('.d-flex.align-items-center.mb-2').forEach((row, idx) => {
                        const dayIdx = Array.from(list.children).filter(el => el.className.includes('text-muted')).length - 1;
                        
                        let item;
                        (dataSets.family.history[currentType][currentPeriod] || []).forEach(day => {
                            day.items.forEach(it => {
                                if (!item && row.innerHTML.includes(it.cat) && row.innerHTML.includes(it.sum.toLocaleString('ru-RU'))) item = it;
                            });
                        });
                        if (item && item.member) {
                            const memberDiv = document.createElement('div');
                            memberDiv.className = 'small text-muted';
                            memberDiv.innerHTML = `<span class='badge' style='background:${item.memberColor};color:#fff;'>${item.member}</span>`;
                            row.querySelector('.flex-grow-1').appendChild(memberDiv);
                        }
                    });
                }
                setTimeout(bindEditOperationBtns, 0);
            };

          
            const origRenderChartFn = renderChart;
            renderChart = function(type = 'pie') {
                if (currentGroup === 'family' && type === 'pie') {
                    // Суммируем траты по участникам
                    const members = dataSets.family.members || [];
                    const labels = [];
                    const data = [];
                    const colors = [];
                    members.forEach(m => {
                        let sum = 0;
                        (dataSets.family.history['expense'][currentPeriod] || []).forEach(day => {
                            (day.items || []).forEach(item => {
                                if (item.member === m.name) sum += item.sum;
                            });
                        });
                        if (sum > 0) {
                            labels.push(m.name);
                            data.push(sum);
                            colors.push(m.color);
                        }
                    });
                    dataSets.family.chart.labels = labels;
                    dataSets.family.chart.data = data;
                    dataSets.family.chart.colors = colors;
                }
                origRenderChartFn(type);
                updateFamilyBudgetUI();
            };

            
            updateFamilyBudgetUI();

            document.getElementById('addMemberBtn')?.addEventListener('click', function() {
              const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
              modal.show();
             
              const familyModal = bootstrap.Modal.getInstance(document.getElementById('familyModal'));
              if(familyModal) familyModal.hide();
            });

            
            const addCategoryForm = document.querySelector('#addCategoryModal form');
            if (addCategoryForm) {
              addCategoryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = this.querySelector('input[type="text"]').value.trim();
                if (!name) return;
                const type = this.querySelector('input[name="catType"]:checked').id === 'catExpense' ? 'expense' : 'income';
                let iconEl = this.querySelector('.icon-choice.selected');
                let icon = iconEl ? iconEl.getAttribute('data-icon') : 'star-fill';
                let color = iconEl ? iconEl.getAttribute('data-color') : '#FF6B6B';
                dataSets[currentGroup].categories.push({ name, icon, color, type });
                saveCategoriesToStorage();
                renderCategories();
                if (typeof bindEditCategoryBtns === 'function') bindEditCategoryBtns();
                updateChartData();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                this.reset();
              });
            }
            
            const addOperationForm = document.querySelector('#addOperationModal form');
            if (addOperationForm) {
              addOperationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const catSelect = this.querySelector('select:not([name="member"])');
                const catName = catSelect.value;
                if (!catName || catName === 'Категория') return;
                const sumInput = this.querySelector('input[type="number"]');
                const sum = parseFloat(sumInput.value);
                if (!sum || sum <= 0) return;
                const dateInput = this.querySelector('input[type="date"]');
                const date = dateInput.value || (new Date()).toISOString().slice(0,10);
                const commentInput = this.querySelector('input[type="text"]');
                const comment = commentInput.value.trim();
                const cat = dataSets[currentGroup].categories.find(c => c.name === catName);
                if (!cat) return;
                let periodArr = dataSets[currentGroup].history[currentType][currentPeriod];
                let day = periodArr.find(d => d.date === date);
                if (!day) {
                  day = { date, items: [] };
                  periodArr.push(day);
                }
                let memberSelect = this.querySelector('select[name="member"]');
                let memberIdx = memberSelect && memberSelect.value !== '' ? +memberSelect.value : null;
                let member = null;
                if (currentGroup === 'family' && memberIdx !== null && dataSets.family.members[memberIdx]) {
                  member = dataSets.family.members[memberIdx];
                }
                const newItem = {
                  cat: cat.name,
                  icon: cat.icon,
                  color: cat.color,
                  sum: sum,
                  sub: comment
                };
                if (member) {
                  newItem.member = member.name;
                  newItem.memberColor = member.color;
                }
                day.items.push(newItem);
                checkBudgetLimit(cat.name);
                updateChartData();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                renderHistory(currentType, currentPeriod, true);
                if (typeof bindEditOperationBtns === 'function') bindEditOperationBtns();
                saveHistoryToStorage();
                bootstrap.Modal.getInstance(document.getElementById('addOperationModal')).hide();
                this.reset();
              });
            }

            document.getElementById('editCategoryModal').addEventListener('show.bs.modal', function() {
                const form = this.querySelector('form');
                const idx = +form.getAttribute('data-edit-idx');
                const cat = dataSets[currentGroup].categories[idx];
                if (!cat) return;
                
                const iconBlock = form.querySelector('.mb-3 label.form-label + .d-flex');
                if (iconBlock) {
                    iconBlock.innerHTML = icons.map((ic, i) => `
                        <div class="d-flex flex-column align-items-center">
                            <div class="rounded-circle icon-choice${cat.icon===ic.icon?' selected':''}" data-icon="${ic.icon}" data-color="${ic.color}" style="width:56px;height:56px;background:${ic.color};display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;">
                                <i class="bi bi-${ic.icon}"></i>
                            </div>
                            <div class="small">${ic.label}</div>
                        </div>
                    `).join('');
                    
                    iconBlock.querySelectorAll('.icon-choice').forEach(el => {
                        el.onclick = function() {
                            iconBlock.querySelectorAll('.icon-choice').forEach(e=>e.classList.remove('selected'));
                            this.classList.add('selected');
                            const label = this.parentElement.querySelector('.small')?.textContent;
                            if (label) {
                                form.querySelector('input[type="text"]').value = label;
                            }
                        };
                    });
                }
            });

           
            document.querySelectorAll('#addMemberModal .color-choice').forEach(circle => {
                circle.addEventListener('click', function() {
                    // Убираем выделение со всех кругов
                    document.querySelectorAll('#addMemberModal .color-choice').forEach(c => c.classList.remove('selected'));
                    // Добавляем выделение на выбранный круг
                    this.classList.add('selected');
                });
            });
            
            
            document.querySelector('#addMemberModal form').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = this.querySelector('input[type="text"]').value.trim();
                const email = this.querySelector('input[type="email"]').value.trim();
                const selectedColor = this.querySelector('.color-choice.selected').style.background;
                
                if (!name) return;
                
                dataSets.family.members.push({ name, email, color: selectedColor });
                saveFamilyMembersToStorage();
                renderFamilyMembers();
                
                bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
                this.reset();
            });

           
        
            document.getElementById('editOperationModal').addEventListener('click', function(e) {
              if (e.target.closest('.btn-danger')) {
                const form = this.querySelector('form');
                if (!form) return;
                e.preventDefault();
                const oldDayIdx = +form.getAttribute('data-edit-day-idx');
                const oldItemIdx = +form.getAttribute('data-edit-item-idx');
                const periodArr = dataSets[currentGroup].history[currentType][currentPeriod];
                const oldDay = periodArr[oldDayIdx];
                if (oldDay && oldDay.items[oldItemIdx]) {
                  oldDay.items.splice(oldItemIdx, 1);
                  if (oldDay.items.length === 0) {
                    periodArr.splice(oldDayIdx, 1);
                  }
                  saveHistoryToStorage();
                  renderHistory(currentType, currentPeriod, true);
                  updateChartData();
                  renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                }
                const modal = bootstrap.Modal.getInstance(document.getElementById('editOperationModal'));
                if (modal) modal.hide();
              }
            });

            document.getElementById('editOperationModal').addEventListener('submit', function(e) {
              if (e.target.tagName === 'FORM') {
                e.preventDefault();
                const form = e.target;
                const select = form.querySelector('select:not([name="member"])'); // исправлено!
                const catName = select.value;
                const sum = parseFloat(form.querySelector('input[type="number"]').value);
                const date = form.querySelector('input[type="date"]').value;
                const comment = form.querySelector('input[type="text"]').value.trim();
                if (!catName || catName === 'Категория' || !sum || sum <= 0 || !date) return;
                const cat = dataSets[currentGroup].categories.find(c => c.name === catName);
                if (!cat) return;
                const oldDayIdx = +form.getAttribute('data-edit-day-idx');
                const oldItemIdx = +form.getAttribute('data-edit-item-idx');
                const oldDay = dataSets[currentGroup].history[currentType][currentPeriod][oldDayIdx];
                if (oldDay) oldDay.items.splice(oldItemIdx, 1);
                let periodArr = dataSets[currentGroup].history[currentType][currentPeriod];
                let day = periodArr.find(d => d.date === date);
                if (!day) {
                  day = { date, items: [] };
                  periodArr.push(day);
                }
                let memberSelect = form.querySelector('select[name="member"]');
                let memberIdx = memberSelect && memberSelect.value !== '' ? +memberSelect.value : null;
                let member = null;
                if (currentGroup === 'family' && memberIdx !== null && dataSets.family.members[memberIdx]) {
                  member = dataSets.family.members[memberIdx];
                }
                const newItem = {
                  cat: cat.name,
                  icon: cat.icon,
                  color: cat.color,
                  sum: sum,
                  sub: comment
                };
                if (member) {
                  newItem.member = member.name;
                  newItem.memberColor = member.color;
                }
                day.items.push(newItem);
                saveHistoryToStorage();
                renderHistory(currentType, currentPeriod, true);
                updateChartData();
                renderChart(document.querySelector('.chart-type-btn.active').dataset.type);
                const modal = bootstrap.Modal.getInstance(document.getElementById('editOperationModal'));
                if (modal) modal.hide();
              }
            });    
});
</script>
</body>
</html>